(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{160:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return s})),t.d(n,"metadata",(function(){return c})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return p}));var r=t(3),a=t(7),o=(t(0),t(385)),s={title:"20. \u7cbe\u8bfb \u300aNestjs \u6587\u6863\u300b",id:"020",hide_title:!0},c={unversionedId:"020",id:"020",isDocsHomePage:!1,title:"20. \u7cbe\u8bfb \u300aNestjs \u6587\u6863\u300b",description:"\u672c\u671f\u7cbe\u8bfb\u7684\u6587\u7ae0\u662f\uff1aNestjs \u6587\u6863",source:"@site/weekly/020.\u7cbe\u8bfb\u300aNestjs\u300b\u6587\u6863.md",slug:"/020",permalink:"/weekly/020",editUrl:"https://github.com/coder-study-room/Front-end-Advanced-Route/edit/master/weekly/020.\u7cbe\u8bfb\u300aNestjs\u300b\u6587\u6863.md",version:"current",lastUpdatedBy:"wangweidong",lastUpdatedAt:1617879406,formattedLastUpdatedAt:"4/8/2021",sidebar:"weekly",previous:{title:"19. \u7cbe\u8bfb\u300a\u6700\u4f73\u524d\u7aef\u9762\u8bd5\u9898\u300b\u53ca\u9762\u8bd5\u5b98\u6280\u5de7",permalink:"/weekly/019"},next:{title:"21. \u7cbe\u8bfb\u300aWeb fonts: when you need them, when you don\u2019t\u300b",permalink:"/weekly/021"}},l=[{value:"1 \u5f15\u8a00",id:"1-\u5f15\u8a00",children:[]},{value:"2 \u5185\u5bb9\u6982\u8981",id:"2-\u5185\u5bb9\u6982\u8981",children:[{value:"2.1 Modules, Controllers, Components",id:"21-modules-controllers-components",children:[]},{value:"2.2 \u88c5\u9970\u5668\u8def\u7531",id:"22-\u88c5\u9970\u5668\u8def\u7531",children:[]},{value:"2.3 \u6a21\u5757\u95f4\u4f9d\u8d56\u6ce8\u5165",id:"23-\u6a21\u5757\u95f4\u4f9d\u8d56\u6ce8\u5165",children:[]},{value:"2.4 \u88c5\u9970\u5668\u53c2\u6570",id:"24-\u88c5\u9970\u5668\u53c2\u6570",children:[]}]},{value:"3 \u7cbe\u8bfb",id:"3-\u7cbe\u8bfb",children:[{value:"3.1 Typeorm",id:"31-typeorm",children:[]},{value:"3.2 \u90e8\u7f72",id:"32-\u90e8\u7f72",children:[]}]},{value:"4 \u603b\u7ed3",id:"4-\u603b\u7ed3",children:[]}],i={toc:l};function p(e){var n=e.components,t=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},i,t,{components:n,mdxType:"MDXLayout"}),Object(o.b)("p",null,"\u672c\u671f\u7cbe\u8bfb\u7684\u6587\u7ae0\u662f\uff1a",Object(o.b)("a",{parentName:"p",href:"https://docs.nestjs.com/"},"Nestjs \u6587\u6863")),Object(o.b)("p",null,"\u4f53\u9a8c\u4e00\u4e0b nodejs mvc \u6846\u67b6\u7684\u4f18\u96c5\u8bbe\u8ba1\u3002"),Object(o.b)("h2",{id:"1-\u5f15\u8a00"},"1 \u5f15\u8a00"),Object(o.b)("p",null,"Nestjs \u662f\u6211\u89c1\u8fc7\u7684\uff0c\u5c06 Typescript \u4e0e Nodejs Framework \u7ed3\u5408\u7684\u6700\u597d\u7684\u4f8b\u5b50\u3002"),Object(o.b)("h2",{id:"2-\u5185\u5bb9\u6982\u8981"},"2 \u5185\u5bb9\u6982\u8981"),Object(o.b)("p",null,"Nestjs \u4e0d\u662f\u4e00\u4e2a\u65b0\u8f6e\u5b50\uff0c\u5b83\u662f\u57fa\u4e8e Express\u3001socket.io \u5c01\u88c5\u7684 nodejs \u540e\u7aef\u5f00\u53d1\u6846\u67b6\uff0c\u5bf9 Typescript \u5f00\u53d1\u8005\u63d0\u4f9b\u7c7b\u578b\u652f\u6301\uff0c\u4e5f\u80fd\u4f18\u96c5\u964d\u7ea7\u4f9b Js \u4f7f\u7528\uff0c\u62e5\u6709\u8bf8\u591a\u7279\u6027\uff0c\u50cf\u4e2d\u95f4\u4ef6\u7b49\u5c31\u4e0d\u5c55\u5f00\u4e86\uff0c\u672c\u6587\u91cd\u70b9\u5217\u4e3e\u5176\u4eae\u70b9\u7279\u6027\u3002"),Object(o.b)("h3",{id:"21-modules-controllers-components"},"2.1 Modules, Controllers, Components"),Object(o.b)("p",null,"Nestjs \u5f00\u53d1\u56f4\u7ed5\u7740\u8fd9\u4e09\u4e2a\u5355\u8bcd\uff0cModules \u662f\u6700\u5927\u7c92\u5ea6\u7684\u62c6\u5206\uff0c\u8868\u793a\u5e94\u7528\u6216\u8005\u6a21\u5757\u3002Controllers \u662f\u4f20\u7edf\u610f\u4e49\u7684\u63a7\u5236\u5668\uff0c\u4e00\u4e2a Module \u62e5\u6709\u591a\u4e2a Controller\u3002Components \u4e00\u822c\u7528\u4e8e\u505a Services\uff0c\u6bd4\u5982\u5c06\u6570\u636e\u5e93 CRUD \u5c01\u88c5\u5728 Services \u4e2d\uff0c\u6bcf\u4e2a Service \u5c31\u662f\u4e00\u4e2a Component\u3002"),Object(o.b)("h3",{id:"22-\u88c5\u9970\u5668\u8def\u7531"},"2.2 \u88c5\u9970\u5668\u8def\u7531"),Object(o.b)("p",null,"\u88c5\u9970\u5668\u8def\u7531\u662f\u4e2a\u597d\u4e1c\u897f\uff0c\u8def\u7531\u76f4\u63a5\u6807\u5fd7\u5728\u51fd\u6570\u5934\u4e0a\uff0c\u505a\u5230\u4e86\u8def\u7531\u53bb\u4e2d\u5fc3\u5316\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Controller()\nexport class UsersController {\n    @Get('users')\n    getAllUsers() {}\n\n    @Get('users/:id')\n    getUser() {}\n\n    @Post('users')\n    addUser() {}\n}\n")),Object(o.b)("p",null,"\u4ee5\u524d\u7528\u8fc7 Go \u8bed\u8a00\u6846\u67b6 ",Object(o.b)("a",{parentName:"p",href:"https://beego.me/docs/mvc/controller/router.md"},"Beego"),"\uff0c\u5c31\u662f\u91c7\u7528\u4e86\u4e2d\u5fc3\u5316\u8def\u7531\u7ba1\u7406\u65b9\u5f0f\uff0c\u867d\u7136\u5f15\u5165\u4e86 ",Object(o.b)("inlineCode",{parentName:"p"},"namespace")," \u6982\u5ff5\uff0c\u4f46\u5f53\u534f\u4f5c\u8005\u591a\u3001\u6a21\u5757\u4f53\u91cf\u5de8\u5927\u65f6\uff0c\u8def\u7531\u7ba1\u7406\u6210\u672c\u76f4\u7ebf\u4e0a\u5347\u3002Nestjs \u7c7b\u4f3c namespace \u7684\u6982\u5ff5\u901a\u8fc7\u88c5\u9970\u5668\u5b9e\u73b0\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Controller('users')\nexport class UsersController {\n    @Get()\n    getAllUsers(req: Request, res: Response, next: NextFunction) {}\n}\n")),Object(o.b)("p",null,"\u8bbf\u95ee ",Object(o.b)("inlineCode",{parentName:"p"},"/users")," \u65f6\u4f1a\u8fdb\u5165 ",Object(o.b)("inlineCode",{parentName:"p"},"getAllUsers")," \u51fd\u6570\u3002\u53ef\u4ee5\u770b\u5230\u5176 ",Object(o.b)("inlineCode",{parentName:"p"},"namespace")," \u4e5f\u662f\u53bb\u4e2d\u5fc3\u5316\u7684\u3002"),Object(o.b)("h3",{id:"23-\u6a21\u5757\u95f4\u4f9d\u8d56\u6ce8\u5165"},"2.3 \u6a21\u5757\u95f4\u4f9d\u8d56\u6ce8\u5165"),Object(o.b)("p",null,"Modules, Controllers, Components \u4e4b\u95f4\u901a\u8fc7\u4f9d\u8d56\u6ce8\u5165\u76f8\u4e92\u5173\u8054\uff0c\u5b83\u4eec\u901a\u8fc7\u540c\u540d\u7684 ",Object(o.b)("inlineCode",{parentName:"p"},"@Module")," ",Object(o.b)("inlineCode",{parentName:"p"},"@Controller")," ",Object(o.b)("inlineCode",{parentName:"p"},"@Component")," \u88c5\u9970\u5668\u7533\u660e\uff0c\u5982\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Controller()\nexport class UsersController {\n    @Get('users')\n    getAllUsers() {}\n}\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Component()\nexport class UsersService {\n    getAllUsers() {\n        return []\n    }\n}\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Module({\n    controllers: [ UsersController ],\n    components: [ UsersService ],\n})\nexport class ApplicationModule {}\n")),Object(o.b)("p",null,"\u5728 ",Object(o.b)("inlineCode",{parentName:"p"},"ApplicationModule")," \u7533\u660e\u5176\u5185\u90e8 Controllers \u4e0e Components \u540e\uff0c\u5c31\u53ef\u4ee5\u5728 Controllers \u4e2d\u6ce8\u5165 Components \u4e86\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Controller()\nexport class UsersController {\n    constructor(private usersService: UsersService) {}\n    \n    @Get('users')\n    getAllUsers() {\n        return this.usersService.getAllUsers()\n    }\n}\n")),Object(o.b)("h3",{id:"24-\u88c5\u9970\u5668\u53c2\u6570"},"2.4 \u88c5\u9970\u5668\u53c2\u6570"),Object(o.b)("p",null,"\u4e0e\u5927\u90e8\u5206\u6846\u67b6\u4ece ",Object(o.b)("inlineCode",{parentName:"p"},"this.req")," \u6216 ",Object(o.b)("inlineCode",{parentName:"p"},"this.context")," \u7b49\u53d6\u8bf7\u6c42\u53c2\u6570\u4e0d\u540c\uff0cNestjs \u901a\u8fc7\u88c5\u9970\u5668\u83b7\u53d6\u8bf7\u6c42\u53c2\u6570\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Get('/:id')\npublic async getUser(\n    @Response() res,\n    @Param('id') id,\n) {\n    const user = await this.usersService.getUser(id);\n    res.status(HttpStatus.OK).json(user);\n}\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"@Response")," \u83b7\u53d6 res\uff0c",Object(o.b)("inlineCode",{parentName:"p"},"@Param")," \u83b7\u53d6\u8def\u7531\u53c2\u6570\uff0c",Object(o.b)("inlineCode",{parentName:"p"},"@Query")," \u83b7\u53d6 url query \u53c2\u6570\uff0c",Object(o.b)("inlineCode",{parentName:"p"},"@Body")," \u83b7\u53d6 Http body \u53c2\u6570\u3002 "),Object(o.b)("h2",{id:"3-\u7cbe\u8bfb"},"3 \u7cbe\u8bfb"),Object(o.b)("p",null,"\u7531\u4e8e\u4e34\u8fd1\u53cc\u5341\u4e00\uff0c\u9879\u76ee\u5de5\u671f\u5f88\u7d27\u5f20\uff0c\u672c\u671f\u7cbe\u8bfb\u7531\u6211\u72ec\u81ea\u5b8c\u6210 :p\u3002"),Object(o.b)("h3",{id:"31-typeorm"},"3.1 Typeorm"),Object(o.b)("p",null,"\u6709\u4e86\u5982\u6b64\u5f3a\u5927\u7684\u540e\u7aef\u6846\u67b6\uff0c\u5fc5\u987b\u642d\u914d\u4e0a\u540c\u7b49\u5f3a\u5927\u7684 orm \u624d\u80fd\u53d1\u6325\u6700\u5927\u529f\u529b\uff0c",Object(o.b)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm"},"Typeorm")," \u5c31\u662f\u6700\u597d\u7684\u9009\u62e9\u4e4b\u4e00\u3002\u5b83\u4e5f\u5b8c\u5168\u4f7f\u7528 Typescript \u7f16\u5199\uff0c\u4f7f\u7528\u65b9\u5f0f\u5177\u6709\u540c\u6837\u7684\u827a\u672f\u6c14\u606f\u3002"),Object(o.b)("h4",{id:"311-\u5b9a\u4e49\u5b9e\u4f53"},"3.1.1 \u5b9a\u4e49\u5b9e\u4f53"),Object(o.b)("p",null,"\u6bcf\u4e2a\u5b9e\u4f53\u5bf9\u5e94\u6570\u636e\u5e93\u7684\u4e00\u5f20\u8868\uff0cTypeorm \u5728\u6bcf\u6b21\u542f\u52a8\u90fd\u4f1a\u540c\u6b65\u8868\u7ed3\u6784\u5230\u6570\u636e\u5e93\uff0c\u6211\u4eec\u5b8c\u5168\u4e0d\u7528\u4f7f\u7528\u6570\u636e\u5e93\u67e5\u770b\u8868\u7ed3\u6784\uff0c\u6240\u6709\u7ed3\u6784\u4fe1\u606f\u90fd\u5b9a\u4e49\u5728\u4ee3\u7801\u4e2d\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Entity()\nexport class Card {\n  @PrimaryGeneratedColumn({\n    comment: '\u4e3b\u952e',\n  })\n  id: number;\n\n  @Column({\n    comment: '\u540d\u79f0',\n    length: 30,\n    unique: true,\n  })\n  name: string = 'nick';\n}\n")),Object(o.b)("p",null,"\u901a\u8fc7 ",Object(o.b)("inlineCode",{parentName:"p"},"@Entity")," \u5c06\u7c7b\u5b9a\u4e49\u4e3a\u5b9e\u4f53\uff0c\u6bcf\u4e2a\u6210\u5458\u53d8\u91cf\u5bf9\u5e94\u8868\u4e2d\u7684\u6bcf\u4e00\u5217\uff0c\u5982\u4e0a\u5b9a\u4e49\u4e86 ",Object(o.b)("inlineCode",{parentName:"p"},"id")," ",Object(o.b)("inlineCode",{parentName:"p"},"name")," \u4e24\u4e2a\u5217\uff0c\u540c\u65f6\u5217 ",Object(o.b)("inlineCode",{parentName:"p"},"id")," \u901a\u8fc7 ",Object(o.b)("inlineCode",{parentName:"p"},"@PrimaryGeneratedColumn")," \u5b9a\u4e49\u4e3a\u4e86\u4e3b\u952e\u5217\uff0c\u5217 ",Object(o.b)("inlineCode",{parentName:"p"},"name")," \u901a\u8fc7\u53c2\u6570\u5b9a\u4e49\u4e86\u5176\u6700\u5927\u957f\u5ea6\u3001\u552f\u4e00\u7684\u4fe1\u606f\u3002"),Object(o.b)("p",null,"\u81f3\u4e8e\u7c7b\u578b\uff0cTypeorm \u901a\u8fc7\u53cd\u5c04\uff0c\u62ff\u5230\u4e86\u7c7b\u578b\u5b9a\u4e49\uff0c\u81ea\u52a8\u8bc6\u522b ",Object(o.b)("inlineCode",{parentName:"p"},"id")," \u4e3a\u6570\u5b57\u7c7b\u578b\u3001",Object(o.b)("inlineCode",{parentName:"p"},"name")," \u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u624b\u52a8\u8bbe\u7f6e ",Object(o.b)("inlineCode",{parentName:"p"},"type")," \u53c2\u6570\u3002"),Object(o.b)("p",null,"\u5bf9\u4e8e\u521d\u59cb\u503c\uff0c\u4f7f\u7528 js \u8bed\u6cd5\u5c31\u597d\uff0c\u6bd4\u5982\u5c06 ",Object(o.b)("inlineCode",{parentName:"p"},"name")," \u521d\u59cb\u503c\u8bbe\u7f6e\u4e3a ",Object(o.b)("inlineCode",{parentName:"p"},"nick"),"\uff0c\u5728 ",Object(o.b)("inlineCode",{parentName:"p"},"new Card()")," \u65f6\u5df2\u7ecf\u5e26\u4e0a\u4e86\u521d\u59cb\u503c\u3002"),Object(o.b)("h4",{id:"312-\u81ea\u52a8\u6821\u9a8c"},"3.1.2 \u81ea\u52a8\u6821\u9a8c"),Object(o.b)("p",null,"\u5149\u5224\u65ad\u53c2\u6570\u7c7b\u578b\u662f\u4e0d\u591f\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ",Object(o.b)("inlineCode",{parentName:"p"},"class-validator")," \u505a\u4efb\u4f55\u5f62\u5f0f\u7684\u6821\u9a8c\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Column({\n    comment: '\u914d\u7f6e JSON',\n    length: 5000,\n})\n@Validator.IsString({ message: '\u5fc5\u987b\u4e3a\u5b57\u7b26\u4e32' })\n@Validator.Length(0, 5000, { message: '\u957f\u5ea6\u5728 0~5000' })\ncontent: string;\n")),Object(o.b)("p",null,"\u8fd9\u91cc\u9047\u5230\u4e00\u4e2a\u95ee\u9898\uff1a\u65b0\u589e\u5b9e\u4f53\u65f6\uff0c\u9700\u8981\u6821\u9a8c\u6240\u6709\u5b57\u6bb5\uff0c\u4f46\u66f4\u65b0\u5b9e\u4f53\u65f6\uff0c\u7531\u4e8e\u6027\u80fd\u9700\u8981\uff0c\u6211\u4eec\u4e00\u822c\u4e0d\u4f1a\u4e00\u6b21\u67e5\u8be2\u6240\u6709\u5b57\u6bb5\uff0c\u5c31\u9700\u8981\u6307\u5b9a\u66f4\u65b0\u65f6\uff0c\u4e0d\u6821\u9a8c\u6ca1\u6709\u8d4b\u503c\u7684\u5b57\u6bb5\uff0c\u6211\u4eec\u901a\u8fc7 Typeorm \u7684 ",Object(o.b)("inlineCode",{parentName:"p"},"EventSubscriber")," \u5b8c\u6210\u6570\u636e\u5e93\u64cd\u4f5c\u524d\u7684\u4ee3\u7801\u6821\u9a8c\uff0c\u5e76\u63a7\u5236\u65b0\u589e\u65f6\u5168\u5b57\u6bb5\u6821\u9a8c\uff0c\u66f4\u65b0\u65f6\u53ea\u6821\u9a8c\u8d4b\u503c\u7684\u5b57\u6bb5\uff0c\u5220\u9664\u65f6\u4e0d\u505a\u6821\u9a8c\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@EventSubscriber()\nexport class EverythingSubscriber implements EntitySubscriberInterface<any> {\n  // \u63d2\u5165\u524d\u6821\u9a8c\n  async beforeInsert(event: InsertEvent<any>) {\n    const validateErrors = await validate(event.entity);\n    if (validateErrors.length > 0) {\n      throw new HttpException(getErrorMessage(validateErrors), 404);\n    }\n  }\n\n  // \u66f4\u65b0\u524d\u6821\u9a8c\n  async beforeUpdate(event: UpdateEvent<any>) {\n    const validateErrors = await validate(event.entity, {\n      // \u66f4\u65b0\u64cd\u4f5c\u4e0d\u4f1a\u9a8c\u8bc1\u6ca1\u6709\u6d89\u53ca\u7684\u5b57\u6bb5\n      skipMissingProperties: true,\n    });\n    if (validateErrors.length > 0) {\n      throw new HttpException(getErrorMessage(validateErrors), 404);\n    }\n  }\n}\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"HttpException")," \u4f1a\u5728\u6821\u9a8c\u5931\u8d25\u540e\uff0c\u7ec8\u6b62\u6267\u884c\uff0c\u5e76\u7acb\u5373\u8fd4\u56de\u9519\u8bef\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u4e00\u6b65\u4f53\u73b0\u4e86 Nestjs \u4e0e Typeorm \u5b8c\u7f8e\u7ed3\u5408\u3002\u8fd9\u5e26\u6765\u7684\u597d\u5904\u5c31\u662f\uff0c\u6211\u4eec\u653e\u5fc3\u6267\u884c\u4efb\u4f55 CRUD \u8bed\u53e5\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u505a\u9519\u8bef\u5904\u7406\uff0c\u5f53\u6821\u9a8c\u5931\u8d25\u6216\u8005\u6570\u636e\u5e93\u64cd\u4f5c\u5931\u8d25\u65f6\uff0c\u4f1a\u81ea\u52a8\u7ec8\u6b62\u6267\u884c\u540e\u7eed\u4ee3\u7801\uff0c\u5e76\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u53cb\u597d\u7684\u63d0\u793a\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Post()\nasync add(\n  @Res() res: Response,\n  @Body('name') name: string,\n  @Body('description') description: string,\n) {\n  const card = await this.cardService.add(name, description);\n  // \u5982\u679c\u4f20\u5165\u53c2\u6570\u5b9e\u4f53\u6821\u9a8c\u5931\u8d25\uff0c\u4f1a\u7acb\u523b\u8fd4\u56de\u5931\u8d25\uff0c\u5e76\u63d0\u793a `@Validator.IsString({ message: '\u5fc5\u987b\u4e3a\u5b57\u7b26\u4e32' })` \u6ce8\u518c\u65f6\u7684\u63d0\u793a\u4fe1\u606f\n  // \u5982\u679c\u63d2\u5165\u5931\u8d25\uff0c\u4e5f\u4f1a\u7acb\u523b\u8fd4\u56de\u5931\u8d25\n  // \u6240\u4ee5\u53ea\u9700\u8981\u5904\u7406\u6b63\u786e\u60c5\u51b5\n  res.status(HttpStatus.OK).json(card);\n}\n")),Object(o.b)("h4",{id:"313-\u5916\u952e"},"3.1.3 \u5916\u952e"),Object(o.b)("p",null,"\u5916\u952e\u4e5f\u662f Typeorm \u7684\u7279\u8272\u4e4b\u4e00\uff0c\u901a\u8fc7\u88c5\u9970\u5668\u8bed\u4e49\u5316\u89e3\u91ca\u5b9e\u4f53\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u5e38\u7528\u7684\u6709 ",Object(o.b)("inlineCode",{parentName:"p"},"@OneToOne")," ",Object(o.b)("inlineCode",{parentName:"p"},"@OneToMany")," ",Object(o.b)("inlineCode",{parentName:"p"},"@ManyToOne")," ",Object(o.b)("inlineCode",{parentName:"p"},"@ManyToMany")," \u56db\u79cd\uff0c\u6bd4\u5982\u7528\u6237\u8868\u5230\u8bc4\u8bba\u8868\uff0c\u662f\u4e00\u5bf9\u591a\u7684\u5173\u7cfb\uff0c\u53ef\u4ee5\u8fd9\u6837\u8bbe\u7f6e\u5b9e\u4f53\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Entity()\nexport class User {\n  @PrimaryGeneratedColumn({\n    comment: '\u4e3b\u952e',\n  })\n  id: number;\n\n  @OneToMany(type => Comment, comment => comment.user)\n  comments?: Comment[];\n}\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript"},"@Entity()\nexport class Comment {\n  @PrimaryGeneratedColumn({\n    comment: '\u4e3b\u952e',\n  })\n  id: number;\n\n  @ManyToOne(type => User, user => user.Comments)\n  @JoinColumn()\n  user: User;\n}\n")),Object(o.b)("p",null,"\u5bf9 ",Object(o.b)("inlineCode",{parentName:"p"},"User")," \u6765\u8bf4\uff0c\u4e00\u4e2a ",Object(o.b)("inlineCode",{parentName:"p"},"User")," \u5bf9\u5e94\u591a\u4e2a ",Object(o.b)("inlineCode",{parentName:"p"},"Comment"),"\uff0c\u5c31\u4f7f\u7528 ",Object(o.b)("inlineCode",{parentName:"p"},"OneToMany")," \u88c5\u9970\u5668\u88c5\u9970 ",Object(o.b)("inlineCode",{parentName:"p"},"Comments")," \u5b57\u6bb5\uff1b\u5bf9 ",Object(o.b)("inlineCode",{parentName:"p"},"Comment")," \u6765\u8bf4\uff0c\u591a\u4e2a ",Object(o.b)("inlineCode",{parentName:"p"},"Comment")," \u5bf9\u5e94\u4e00\u4e2a ",Object(o.b)("inlineCode",{parentName:"p"},"User"),"\uff0c\u6240\u4ee5\u4f7f\u7528 ",Object(o.b)("inlineCode",{parentName:"p"},"ManyToOne")," \u88c5\u9970 ",Object(o.b)("inlineCode",{parentName:"p"},"User")," \u5b57\u6bb5\u3002"),Object(o.b)("p",null,"\u5728\u4f7f\u7528 Typeorm \u67e5\u8be2 ",Object(o.b)("inlineCode",{parentName:"p"},"User")," \u65f6\uff0c\u4f1a\u81ea\u52a8\u5916\u952e\u67e5\u8be2\u5230\u5176\u5173\u8054\u7684\u8bc4\u8bba\uff0c\u4fdd\u5b58\u5728 ",Object(o.b)("inlineCode",{parentName:"p"},"user.comments")," \u4e2d\u3002\u67e5\u8be2 ",Object(o.b)("inlineCode",{parentName:"p"},"Comment")," \u65f6\uff0c\u4f1a\u81ea\u52a8\u67e5\u8be2\u5230\u5176\u5173\u8054\u7684 ",Object(o.b)("inlineCode",{parentName:"p"},"User"),"\uff0c\u4fdd\u5b58\u5728 ",Object(o.b)("inlineCode",{parentName:"p"},"comment.user")," \u4e2d\u3002"),Object(o.b)("h3",{id:"32-\u90e8\u7f72"},"3.2 \u90e8\u7f72"),Object(o.b)("p",null,"\u53ef\u4ee5\u4f7f\u7528 Docker \u90e8\u7f72 Mysql + Nodejs\uff0c\u901a\u8fc7 ",Object(o.b)("inlineCode",{parentName:"p"},"docker-compose")," \u5c06\u6570\u636e\u5e93\u4e0e\u670d\u52a1\u90fd\u8dd1\u5728 docker \u4e2d\uff0c\u5185\u90e8\u901a\u4fe1\u3002"),Object(o.b)("p",null,"\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f nodejs \u670d\u52a1\u8fd0\u884c\u65f6\uff0c\u8981\u7b49\u5f85\u6570\u636e\u5e93\u670d\u52a1\u542f\u52a8\u5b8c\u6bd5\uff0c\u4e5f\u5c31\u662f\u6709\u4e00\u4e2a\u542f\u52a8\u7b49\u5f85\u7684\u9700\u6c42\u3002\u53ef\u4ee5\u901a\u8fc7 ",Object(o.b)("inlineCode",{parentName:"p"},"environment")," \u6765\u62d3\u5c55\u7b49\u5f85\u529f\u80fd\uff0c\u4ee5\u4e0b\u662f ",Object(o.b)("inlineCode",{parentName:"p"},"docker-compose.yml"),"\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-yml"},'version: "2"\nservices:\n  app:\n    build: ./\n    restart: always\n    ports:\n      - "5000:8000"\n    links:\n      - db\n      - redis\n    depends_on:\n      - db\n      - redis\n    environment:\n      WAIT_HOSTS: db:3306 redis:6379\n')),Object(o.b)("p",null,"\u901a\u8fc7 ",Object(o.b)("inlineCode",{parentName:"p"},"WAIT_HOSTS")," \u6307\u5b9a\u8981\u7b49\u5f85\u54ea\u4e9b\u670d\u52a1\u7684\u7aef\u53e3\u670d\u52a1 ready\u3002\u5728 nodejs ",Object(o.b)("inlineCode",{parentName:"p"},"Dockerfile")," \u542f\u52a8\u7684 ",Object(o.b)("inlineCode",{parentName:"p"},"CMD")," \u52a0\u4e0a\u4e00\u4e2a ",Object(o.b)("inlineCode",{parentName:"p"},"wait-for.sh")," \u811a\u672c\uff0c\u5b83\u4f1a\u8bfb\u53d6 ",Object(o.b)("inlineCode",{parentName:"p"},"WAIT_HOSTS")," \u73af\u5883\u53d8\u91cf\uff0c\u7b49\u5f85\u7aef\u53e3 ready \u540e\uff0c\u518d\u6267\u884c\u540e\u9762\u7684\u542f\u52a8\u811a\u672c\u3002"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-bash"},"CMD ./scripts/docker/wait-for.sh && npm run deploy\n")),Object(o.b)("p",null,"\u4ee5\u4e0b\u662f ",Object(o.b)("inlineCode",{parentName:"p"},"wait.sh")," \u811a\u672c\u5185\u5bb9\uff1a"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nset -e\n\ntimeout=${WAIT_HOSTS_TIMEOUT:-30}\nwaitAfterHosts=${WAIT_AFTER_HOSTS:-0}\nwaitBeforeHosts=${WAIT_BEFORE_HOSTS:-0}\n\necho "Waiting for ${waitBeforeHosts} seconds."\nsleep $waitBeforeHosts\n\n# our target format is a comma separated list where each item is "host:ip"\nif [ -n "$WAIT_HOSTS" ]; then\n  uris=$(echo $WAIT_HOSTS | sed -e \'s/,/ /g\' -e \'s/\\s+/\\n/g\' | uniq)\nfi\n\n# wait for each target\nif [ -z "$uris" ];\n  then echo "No wait targets found." >&2;\n\n  else\n\n  for uri in $uris\n  do\n    host=$(echo $uri | cut -d: -f1)\n    port=$(echo $uri | cut -d: -f2)\n    [ -n "${host}" ]\n    [ -n "${port}" ]\n    echo "Waiting for ${uri}."\n    seconds=0\n    while [ "$seconds" -lt "$timeout" ] && ! nc -z -w1 $host $port\n    do\n      echo -n .\n      seconds=$((seconds+1))\n      sleep 1\n    done\n\n    if [ "$seconds" -lt "$timeout" ]; then\n      echo "${uri} is up!"\n    else\n      echo "  ERROR: unable to connect to ${uri}" >&2\n      exit 1\n    fi\n  done\necho "All hosts are up"\nfi\n\necho "Waiting for ${waitAfterHosts} seconds."\nsleep $waitAfterHosts\n\nexit 0\n')),Object(o.b)("h2",{id:"4-\u603b\u7ed3"},"4 \u603b\u7ed3"),Object(o.b)("p",null,"Nestjs \u4e2d\u95f4\u4ef6\u5b9e\u73b0\u4e5f\u5f88\u7cbe\u5999\uff0c\u4e0e Modules \u5b8c\u7f8e\u7ed3\u5408\u8d77\u6765\uff0c\u7531\u4e8e\u7bc7\u5e45\u9650\u5236\u5c31\u4e0d\u5c55\u5f00\u4e86\u3002"),Object(o.b)("p",null,"\u540e\u7aef\u6846\u67b6\u5df2\u7ecf\u5f88\u6210\u719f\u4e86\uff0c\u76f8\u53cd\u524d\u7aef\u53d1\u5c55\u7684\u5c31\u773c\u82b1\u7f2d\u4e71\u4e86\uff0c\u5982\u679c\u524d\u7aef\u53ef\u4ee5\u820d\u5f03 ie11 \u6d4f\u89c8\u5668\uff0c\u6211\u63a8\u8350\u7eaf proxy \u5b9e\u73b0\u7684 ",Object(o.b)("a",{parentName:"p",href:"https://github.com/ascoders/dob"},"dob"),"\uff0c\u914d\u5408 react \u6548\u7387\u975e\u5e38\u9ad8\u3002"),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"\u8ba8\u8bba\u5730\u5740\u662f\uff1a",Object(o.b)("a",{parentName:"p",href:"https://github.com/dt-fe/weekly/issues/30"},"\u7cbe\u8bfb \u300aNestjs \u6587\u6863\u300b \xb7 Issue #30 \xb7 dt-fe/weekly"))),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"\u5982\u679c\u4f60\u60f3\u53c2\u4e0e\u8ba8\u8bba\uff0c\u8bf7",Object(o.b)("a",{parentName:"p",href:"https://github.com/dt-fe/weekly"},"\u70b9\u51fb\u8fd9\u91cc"),"\uff0c\u6bcf\u5468\u90fd\u6709\u65b0\u7684\u4e3b\u9898\uff0c\u6bcf\u5468\u4e94\u53d1\u5e03\u3002")))}p.isMDXComponent=!0},385:function(e,n,t){"use strict";t.d(n,"a",(function(){return b})),t.d(n,"b",(function(){return u}));var r=t(0),a=t.n(r);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var i=a.a.createContext({}),p=function(e){var n=a.a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},b=function(e){var n=p(e.components);return a.a.createElement(i.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.a.createElement(a.a.Fragment,{},n)}},m=a.a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,i=l(e,["components","mdxType","originalType","parentName"]),b=p(t),m=r,u=b["".concat(s,".").concat(m)]||b[m]||d[m]||o;return t?a.a.createElement(u,c(c({ref:n},i),{},{components:t})):a.a.createElement(u,c({ref:n},i))}));function u(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,s=new Array(o);s[0]=m;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,s[1]=c;for(var i=2;i<o;i++)s[i]=t[i];return a.a.createElement.apply(null,s)}return a.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"}}]);