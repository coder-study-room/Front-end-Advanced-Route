---
title: 理解执行环境与作用域链
---

函数调用都有与之相关的作用域和上下文。从根本上说，范围是基于函数(function-based)而上下文是基于对象(object-based)。换句话说，作用域是和每次函数调用时变量的访问有关，并且每次调用都是独立的。上下文总是关键字 this 的值，是调用当前可执行代码的对象的引用。

## 执行上下文栈(Execution Context Stack)

在 ECMASscript 中的代码有三种类型：global, function 和 eval。

每一种代码的执行都需要依赖自身的上下文。当然 global 的上下文可能涵盖了很多的 function 和 eval 的实例。函数的每一次调用，都会进入函数执行中的上下文,并且来计算函数中变量等的值。eval 函数的每一次执行，也会进入 eval 执行中的上下文，判断应该从何处获取变量的值。

注意，一个 function 可能产生无限的上下文环境，因为一个函数的调用（甚至递归）都产生了一个新的上下文环境。

一系列活动的执行上下文从逻辑上形成一个栈。栈底总是全局上下文，栈顶是当前（活动的）执行上下文。当在不同的执行上下文间切换（退出的而进入新的执行上下文）的时候，栈会被修改（通过压栈或者退栈的形式）。

当 javascript 代码文件被浏览器载入后，默认最先进入的是一个全局的执行上下文。当在全局上下文中调用执行一个函数时，程序流就进入该被调用函数内，此时引擎就会为该函数创建一个新的执行上下文，并且将其压入到执行上下文堆栈的顶部。浏览器总是执行当前在堆栈顶部的上下文，一旦执行完毕，该上下文就会从堆栈顶部被弹出，然后，进入其下的上下文执行代码。这样，堆栈中的上下文就会被依次执行并且弹出堆栈，直到回到全局的上下文。

## 执行上下文(Execution Context)

也称为执行环节，一个执行的上下文可以抽象的理解为 object。每一个执行的上下文都有一系列的属性（我们称为上下文状态），他们用来追踪关联代码的执行进度。主要有三个属性：变量对象(variable object)，this 指针(this value)，作用域链(scope chain)。

### 变量对象(Variable Object)

变量对象(variable object) 是与执行上下文相关的 数据作用域(scope of data) 。 它是与上下文关联的特殊对象，用于存储被定义在上下文中的 变量(variables) 和 函数声明(function declarations) 。 它是一个抽象的概念，不同的上下文中，它表示使用不同的 object。例如，在 global 全局上下文中，变量对象也是全局对象自身[global object]。（这就是我们可以通过全局对象的属性来指向全局变量）。

进入执行上下文时，VO 的初始化过程具体如下：

- 函数的形参（当进入函数执行上下文时） 变量对象的一个属性，其属性名就是形参的名字，其值就是实参的值；对于没有传递的参数，其值为 undefined

- 函数声明（FunctionDeclaration, FD） 变量对象的一个属性，其属性名和值都是函数对象创建出来的；如果变量对象已经包含了相同名字的属性，则替换它的值

- 变量声明（var，VariableDeclaration） 变量对象的一个属性，其属性名即为变量名，其值为 undefined;如果变量名和已经声明的函数名或者函数的参数名相同，则不会影响已经存在的属性。

执行代码的时候，VO 的一些 Undefined 值会被确定。

### 活动对象(activation object)

当函数被调用者激活，这个特殊的活动对象(activation object) 就被创建了。它包含普通参数(formal parameters) 与特殊参数(arguments)对象(具有索引属性的参数映射表)。活动对象在函数上下文中作为变量对象使用。

即：函数的变量对象保持不变，但除去存储变量与函数声明之外，还包含以及特殊对象 arguments 。

AO 是在进入函数的执行上下文时创建的，并为该对象初始化一个 arguments 属性，该属性的值为 Arguments 对象。

### 作用域链(scope chain)

作用域链的原理和原型链很类似，如果这个变量在自己的作用域中没有，那么它会寻找父级的，直到最顶层。JS 的语法风格和 C/C++类似, 但作用域的实现却和 C/C++不同，并非用“堆栈”方式，而是使用列表，具体过程如下(ECMA262 中所述):

- 任何执行上下文时刻的作用域, 都是由作用域链(scope chain, 后面介绍)来实现.
- 在一个函数被定义的时候, 会将它定义时刻的 scope chain 链接到这个函数对象的[[scope]]属性.
- 在一个函数对象被调用的时候，会创建一个活动对象(也就是一个对象), 然后对于每一个函数的形参，都命名为该活动对象的命名属性, 然后将这个活动对象做为此时的作用域链(scope chain)最前端, 并将这个函数对象的[[scope]]加入到 scope chain 中.

在一般情况下，一个作用域链包括父级变量对象（variable object）（作用域链的顶部）、函数自身变量 VO 和活动对象（activation object）。不过，有些情况下也会包含其它的对象，例如在执行期间，动态加入作用域链中的—例如 with 或者 catch 语句。**[译注：with-objects 指的是 with 语句，产生的临时作用域对象；catch-clauses 指的是 catch 从句，如 catch(e)，这会产生异常对象，导致作用域变更]**。

当查找标识符的时候，会从作用域链的活动对象部分开始查找，然后(如果标识符没有在活动对象中找到)查找作用域链的顶部，循环往复，就像作用域链那样。

## 参考资料

- [深入理解 JavaScript 系列（14）：作用域链(Scope Chain)](https://www.cnblogs.com/tomxu/archive/2012/01/18/2312463.html)
- [javascript 执行环境，变量对象，作用域链](https://segmentfault.com/a/1190000000533094)
- [认识 javascript 中的作用域和上下文](https://yanhaijing.com/javascript/2013/08/30/understanding-scope-and-context-in-javascript/)
- [Javascript 作用域原理](https://www.laruence.com/2009/05/28/863.html)
